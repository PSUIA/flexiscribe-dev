generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  STUDENT
  EDUCATOR
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

model User {
  id          String  @id @default(cuid())
  email       String  @unique
  password    String
  role        Role
  phoneNumber String?

  token       String?   @unique
  tokenExpiry DateTime?

  student  Student?
  educator Educator?
  admin    Admin?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id            String   @id @default(cuid())
  studentNumber String   @unique
  username      String?  @unique
  fullName      String
  yearLevel     String
  section       String
  program       String
  gender        Gender
  birthDate     DateTime
  xp            Int      @default(0)
  avatar        String?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  quizAttempts QuizAttempt[]

  achievements StudentAchievement[]
  badges       StudentBadge[]
  classes      StudentClass[]
}

model Educator {
  id        String   @id @default(cuid())
  username  String   @unique
  fullName  String
  gender    Gender
  birthDate DateTime

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  classes        Class[]
  transcriptions Transcription[]
  notifications  Notification[]
}

model Department {
  id        String     @id @default(cuid())
  name      String     @unique
  educators Educator[]
}

enum QuizType {
  MCQ
  FILL_IN_BLANK
  FLASHCARD
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model Lesson {
  id        String   @id @default(cuid())
  title     String
  subject   String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quizzes Quiz[]

  @@index([subject])
}

model Quiz {
  id       String @id @default(cuid())
  lessonId String
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  type           QuizType
  difficulty     Difficulty
  totalQuestions Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@index([lessonId])
}

model QuizQuestion {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionText String @db.Text
  questionData Json // Stores type-specific data (choices, answer, distractors, etc.)
  orderIndex   Int

  createdAt DateTime @default(now())

  @@index([quizId])
}

model QuizAttempt {
  id     String @id @default(cuid())
  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  score          Float
  totalQuestions Int
  answers        Json // Stores student answers
  completedAt    DateTime @default(now())

  @@index([quizId])
  @@index([studentId])
}

model Achievement {
  id          String   @id @default(cuid())
  title       String
  description String
  icon        String
  category    String
  xpRequired  Int
  createdAt   DateTime @default(now())

  studentAchievements StudentAchievement[]
}

model Badge {
  id          String   @id @default(cuid())
  title       String
  description String
  icon        String
  xpRequired  Int
  createdAt   DateTime @default(now())

  studentBadges StudentBadge[]
}

model StudentAchievement {
  id            String   @id @default(cuid())
  studentId     String
  achievementId String
  earnedAt      DateTime @default(now())

  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([studentId, achievementId])
}

model StudentBadge {
  id        String   @id @default(cuid())
  studentId String
  badgeId   String
  earnedAt  DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge   Badge   @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeId])
}

model Class {
  id        String  @id @default(cuid())
  classCode String  @unique @default(cuid())
  subject   String
  section   String
  room      String
  day       String
  startTime String
  endTime   String?
  students  Int     @default(0)

  educatorId String
  educator   Educator @relation(fields: [educatorId], references: [id], onDelete: Cascade)

  transcriptions Transcription[]
  enrollments    StudentClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([educatorId])
}

model StudentClass {
  id        String   @id @default(cuid())
  studentId String
  classId   String
  joinedAt  DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
}

model Transcription {
  id       String  @id @default(cuid())
  title    String
  course   String
  date     String
  duration String
  content  String  @db.Text
  rawText  String? @db.Text

  transcriptJson Json?
  summaryJson    Json?
  status         String  @default("COMPLETED")
  sessionId      String?

  classId String?
  class   Class?  @relation(fields: [classId], references: [id], onDelete: SetNull)

  educatorId String
  educator   Educator @relation(fields: [educatorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([educatorId])
  @@index([course])
  @@index([classId])
  @@index([status])
}

model Notification {
  id      String  @id @default(cuid())
  title   String
  message String
  type    String  @default("info")
  read    Boolean @default(false)

  educatorId String?
  educator   Educator? @relation(fields: [educatorId], references: [id], onDelete: Cascade)

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([educatorId])
  @@index([adminId])
  @@index([read])
}

model Admin {
  id       String  @id @default(cuid())
  username String  @unique
  fullName String
  avatar   String?

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  notifications Notification[]
  auditLogs     AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id       String  @id @default(cuid())
  action   String
  details  String? @db.Text
  userRole Role
  userName String

  adminId String?
  admin   Admin?  @relation(fields: [adminId], references: [id], onDelete: SetNull)

  userId String?

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([userId])
  @@index([createdAt])
}

model Activity {
  id          String  @id @default(cuid())
  action      String
  description String?
  userRole    Role
  userName    String
  userId      String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
